function resetVars(){measureNumber=0}function BufferLoader(e,t,r){this.context=e,this.urlList=t,this.onload=r,this.bufferList=[],this.loadCount=0}function init(){window.AudioContext=window.AudioContext||window.webkitAudioContext,context=new AudioContext,gainNode=context.createGain(),gainNode.connect(context.destination),bufferLoader=new BufferLoader(context,["https://nichodon.github.io/programs/0003/sounds/click1.wav","https://nichodon.github.io/programs/0003/sounds/click2.wav","https://nichodon.github.io/programs/0003/sounds/click3.wav","https://nichodon.github.io/programs/0003/sounds/accent1.wav"],finishedLoading),bufferLoader.load()}function finishedLoading(e){click1=context.createBufferSource(),click2=context.createBufferSource(),click3=context.createBufferSource(),accent1=context.createBufferSource(),click1.buffer=e[0],click2.buffer=e[1],click3.buffer=e[2],accent1.buffer=e[3],click1.connect(context.destination),click2.connect(context.destination),click3.connect(context.destination),accent1.connect(context.destination),buffers=e}function playSound(e,t){if(play){var r=context.createBufferSource();r.buffer=buffers[e],r.start(t),r.connect(gainNode),gainNode.connect(context.destination),audios.push(r)}}function togglePlayback(){var e=document.getElementById("togglePlayback");stopStartCount+=1,play=!play,play?(e.innerHTML="Stop",measureNumber=0,playBeat(-1,stopStartCount)):(e.innerHTML="Play",measureNumber=0,stopAll(),resetVars())}function isNormalInteger(e){var t=Math.floor(+e);return t+""===e&&t>=0}function mod(e,t){return(e%t+t)%t}function parenthesesAreBalanced(e){var t,r,a,n="[]{}()",i=[];for(t=0;r=e[t];t++)if(a=n.indexOf(r),-1!==a)if(a%2===0)i.push(a+1);else if(0===i.length||i.pop()!==a)return!1;return 0===i.length}function parseMultipliers(e){if(!parenthesesAreBalanced(e))return!1;e=e.trim("*").trim(",");var t=e,r=0;for(i=0;i<e.length-1;i++)if("*"==e[i]&&isNormalInteger(e[i+1])){for(t=t.insert(i+1+2*r,"("),j=i;j<e.length&&isNormalInteger(e[j]);)j+=1;t=t.insert(j+3+2*r,")"),r+=1}e=t;var a=0,n=0;for(i=0;i<e.length-1;i++)"*"==e[i]&&"("==e[i+1]?(n+=1,n>a&&(a=n)):")"==e[i]&&(n-=1);for(depth=a;depth>0;depth--){if(t.length>2e3)return!1;for(e=t,offset=0,n=0,i=0;i<e.length-1;i++)if("*"==e[i]&&"("==e[i+1]){if(n+=1,depth==n)for(j=i+1;j<e.length;j++)if(")"==e[j]){var o=e.substring(i+2,j),u=null,s=-1;for(k=i-1;k>=0;k--)if(!isNormalInteger(e[k])){u=e.substring(k+1,i),s=k;break}if(null==u&&(u=e.substring(0,i)),u>30)return!1;var c=null;","!=o[o.length-1]?(o+="+",c=o.repeat(u)):c=o.repeat(u),t=t.substring(0,s+1+offset)+c+t.substring(j+1+offset),offset+=c.length-j+s;break}}else")"==e[i]&&(n-=1)}return e=t.replace(/\+\++/g,"+").replace(/\,\,+/g,",").trim("+").trim(",")}function updateSignature(){var e=document.getElementById("numerator").value;e=e.replace(/\s/g,"");var t=parseMultipliers(e),r=document.getElementById("denominator").value;if(console.log(e),0==t)return void(document.getElementById("numerator").style.backgroundColor="#FF9184");for(t=t.split(","),numerators=[],j=0;j<t.length;j++){var a=t[j].trim("+").split("+");if(0===a.length)return;var n=0,o=0,u=!0;for(i=accents.length;i<t.length;i++)accents.push([]);for(i=0;i<a.length;i++){accents[j][n]=!0;var s=n,c=a[i];for(isNormalInteger(c)&&parseInt(c)<=100?(n+=parseInt(c),o+=parseInt(c)):u=!1,k=s+1;n>k;k++)accents[j][k]=!1}u?(document.getElementById("numerator").style.backgroundColor="white",numerators.push(o)):document.getElementById("numerator").style.backgroundColor="#FF9184"}return isNormalInteger(r)?(r=parseInt(r),1>r||r>64||Math.log2(r)%1!==0?document.getElementById("denominator").style.backgroundColor="#FF9184":(denominator=r,document.getElementById("denominator").style.backgroundColor="white"),play&&togglePlayback(),updateBPM(),clearCanvas(),void drawBeats()):void(document.getElementById("denominator").style.backgroundColor="#FF9184")}function updateVolume(){volume=document.getElementById("volume").value/100,gainNode.gain.value=volume}function updateBPM(){var e=document.getElementById("bpm").value;5>e||e>800||(bpm=e,bpm*=beatLength*denominator,bps=bpm/60,bpms=bps/1e3,mpb=1/bpm,spb=1/bps,mspb=1/bpms,play&&togglePlayback())}function accurateTimeout(e,t){if(play){if(timeRes>t)return void setTimeout(e(),0);var r=1e3*context.currentTime;timeoutSelfCall(e,r+t)}}function timeoutSelfCall(e,t){if(play){var r=1e3*context.currentTime;return timeRes>t-r?void(play&&setTimeout(e(),0)):void setTimeout(function(){timeoutSelfCall(e,t)},Math.max((t-r)/2,0))}}function stopAll(){for(i=0;i<audios.length;i++)audios[i].stop()}function playBeat(e,t){if(t==stopStartCount&&play){for(-1===e&&(e=1e3*context.currentTime),audios=[],flyLine(-1,0,measureNumber),i=0;i<numerators[measureNumber];i++)accents[measureNumber][i]?playSound(3,e/1e3+i*spb):playNonAccentedBeats&&playSound(0,e/1e3+i*spb),playNonAccentedBeats&&(eighthNoteSub?playSound(1,e/1e3+(i+swingValue/100)*spb):sixteenthNoteSub?(playSound(2,e/1e3+(i+.25)*spb),playSound(2,e/1e3+(i+.5)*spb),playSound(2,e/1e3+(i+.75)*spb)):tripletNoteSub&&(playSound(1,e/1e3+(i+1/3)*spb),playSound(1,e/1e3+(i+2/3)*spb)));var r=1e3*context.currentTime,a=stopStartCount;accurateTimeout(function(){measureNumber=(measureNumber+1)%numerators.length,playBeat(e+mspb*numerators[mod(measureNumber-1,numerators.length)],a)},mspb*numerators[measureNumber]+e-r-20)}}function flyLine(e,t,r){if(r==measureNumber){if(clearCanvas(),!play)return void drawBeats();var a=100+1300*t/(60*spb*numerators[measureNumber]);if(drawBeats(a),1400>a){ctx.beginPath(),ctx.moveTo(a,100),ctx.lineTo(a,300),ctx.stroke(),-1===e&&(e=1e3*context.currentTime);var n=1e3*context.currentTime;accurateTimeout(function(){flyLine(e+1e3/60,t+1,r)},e-n+1e3/60)}}}function beatToCoords(e){return[100+1300*e/numerators[measureNumber],200]}function drawCircle(e,t){ctx.beginPath(),ctx.arc(e[0],e[1],t,0,2*Math.PI),ctx.stroke()}function drawFilledCircle(e,t){ctx.beginPath(),ctx.arc(e[0],e[1],t,0,2*Math.PI),ctx.fillStyle="red",ctx.fill(),ctx.stroke()}function clearCanvas(){ctx.clearRect(0,0,canvas.width,canvas.height)}function drawBeats(e){null==e&&(e=100),ctx.fillStyle="black",numerators.length>1?ctx.fillText("Measure "+(measureNumber+1)+"/"+numerators.length,10,30):ctx.fillText("Measure 1",10,30),ctx.fillText("Time Signature: "+(isNaN(numerators[measureNumber])?0:numerators[measureNumber])+"/"+denominator,10,120);var t="",r=0;for(i=1;i<=numerators[measureNumber];i++)accents[measureNumber][i%numerators[measureNumber]]&&(t=t+(i-r+"")+"+",r=i);ctx.fillText("Accent Pattern: "+(0==t.length?0:t.substring(0,t.length-1)),10,90);var a=Math.min(Math.floor(numerators[measureNumber]*((e-100)/1300)+1),numerators[measureNumber]);if(isNormalInteger(a)?ctx.fillText("Beat",10,60):isNaN(a)?ctx.fillText("Beat 1",10,60):ctx.fillText("Beat "+Math.min(Math.floor(numerators[measureNumber]*((e-100)/1300)+1),numerators[measureNumber]),10,60),!eighthNoteSub&&!sixteenthNoteSub&&!tripletNoteSub)for(i=0;i<=numerators[measureNumber];i++){var n=beatToCoords(i);i!=numerators[measureNumber]&&Math.abs(n[0]-e+5)<20?accents[measureNumber][i%numerators[measureNumber]]?drawFilledCircle(beatToCoords(i),accentCircleRadius):playNonAccentedBeats&&drawFilledCircle(beatToCoords(i),normalCircleRadius):accents[measureNumber][i%numerators[measureNumber]]?drawCircle(beatToCoords(i),accentCircleRadius):playNonAccentedBeats&&drawCircle(beatToCoords(i),normalCircleRadius)}if(eighthNoteSub)for(i=0;i<=numerators[measureNumber];i+=.5){var n=null;n=beatToCoords(i%1===0?i:i+swingValue/100-.5),i!=numerators[measureNumber]&&Math.abs(n[0]-e+5)<20?i%1===0?accents[measureNumber][i%numerators[measureNumber]]?drawFilledCircle(beatToCoords(i),accentCircleRadius):playNonAccentedBeats&&drawFilledCircle(beatToCoords(i),normalCircleRadius):playNonAccentedBeats&&drawFilledCircle(beatToCoords(i+swingValue/100-.5),eighthCircleRadius):i%1===0?accents[measureNumber][i%numerators[measureNumber]]?drawCircle(beatToCoords(i),accentCircleRadius):playNonAccentedBeats&&drawCircle(beatToCoords(i),normalCircleRadius):playNonAccentedBeats&&drawCircle(beatToCoords(i+swingValue/100-.5),eighthCircleRadius)}if(tripletNoteSub)for(i=0;i<=numerators[measureNumber];i+=1/3){var n=beatToCoords(i);i!=numerators[measureNumber]&&Math.abs(n[0]-e+5)<20?.5-Math.abs(i%1-.5)<.01?accents[measureNumber][Math.round(i)%numerators[measureNumber]]?drawFilledCircle(beatToCoords(i),accentCircleRadius):playNonAccentedBeats&&drawFilledCircle(beatToCoords(i),normalCircleRadius):drawFilledCircle(beatToCoords(i),tripletCircleRadius):.5-Math.abs(i%1-.5)<.01?accents[measureNumber][Math.round(i)%numerators[measureNumber]]?drawCircle(beatToCoords(i),accentCircleRadius):playNonAccentedBeats&&drawCircle(beatToCoords(i),normalCircleRadius):playNonAccentedBeats&&drawCircle(beatToCoords(i),tripletCircleRadius)}if(sixteenthNoteSub)for(i=0;i<=numerators[measureNumber];i+=.25){var n=beatToCoords(i);i!=numerators[measureNumber]&&Math.abs(n[0]-e+5)<20?i%1===0?accents[measureNumber][i%numerators[measureNumber]]?drawFilledCircle(beatToCoords(i),accentCircleRadius):playNonAccentedBeats&&drawFilledCircle(beatToCoords(i),normalCircleRadius):playNonAccentedBeats&&drawFilledCircle(beatToCoords(i),sixteenthCircleRadius):i%1===0?accents[measureNumber][i%numerators[measureNumber]]?drawCircle(beatToCoords(i),accentCircleRadius):playNonAccentedBeats&&drawCircle(beatToCoords(i),normalCircleRadius):playNonAccentedBeats&&drawCircle(beatToCoords(i),sixteenthCircleRadius)}}function updateBeatLength(e){beatLength=e/4,updateBPM()}function updateSubdivisions(e){0===e?(eighthNoteSub=!1,tripletNoteSub=!1,sixteenthNoteSub=!1,document.getElementById("swingValue").disabled=!0):1===e?(eighthNoteSub=!0,tripletNoteSub=!1,sixteenthNoteSub=!1,document.getElementById("swingValue").disabled=!1):2===e?(eighthNoteSub=!1,tripletNoteSub=!0,sixteenthNoteSub=!1,document.getElementById("swingValue").disabled=!0):3===e&&(eighthNoteSub=!1,tripletNoteSub=!1,sixteenthNoteSub=!0,document.getElementById("swingValue").disabled=!0),play&&togglePlayback(),clearCanvas(),drawBeats()}function updatePlayNA(){playNonAccentedBeats=document.getElementById("playNonAccentedBeats").checked,clearCanvas(),drawBeats()}function adjustNumeratorWidth(){var e=document.getElementById("numerator"),t=document.createElement("span");t.className="input-element tmp-element",t.innerHTML=e.value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),document.body.appendChild(t);var r=t.getBoundingClientRect().width+20;document.body.removeChild(t),e.style.width=Math.max(r,80)+"px",document.getElementById("signature").style.maxWidth=Math.max(r,80)+"px"}function updateSwing(){swingValue=document.getElementById("swingValue").value,play&&togglePlayback(),clearCanvas(),drawBeats()}function initSequence(){drawBeats(),document.getElementById("numerator").onkeyup=adjustNumeratorWidth,adjustNumeratorWidth()}var numerators=[4],denominator=4,bpm=120,bps=bpm/60,bpms=bps/1e3,mpb=1/bpm,spb=1/bps,mspb=1/bpms,timeRes=30,accent1="sounds/accent1.wav",click1="sounds/click1.wav",click2="sounds/click2.wav",click3="sounds/click3.wav",measureNumber=0,accents=[[!0,!1,!1,!1]],volume=.8,play=!1,canvas=document.getElementById("beater"),ctx=canvas.getContext("2d");ctx.font="20px Georgia";var accentCircleRadius=20,normalCircleRadius=10,eighthCircleRadius=5,sixteenthCircleRadius=2,tripletCircleRadius=4,flylineNumber=0,audios=[],stopStartCount=0,beatLength=.25,eighthNoteSub=!1,sixteenthNoteSub=!1,tripletNoteSub=!1,playNonAccentedBeats=!0,swingValue=50;window.onload=init;var context,bufferLoader,gainNode;BufferLoader.prototype.loadBuffer=function(e,t){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer";var a=this;r.onload=function(){a.context.decodeAudioData(r.response,function(r){return r?(a.bufferList[t]=r,void(++a.loadCount===a.urlList.length&&a.onload(a.bufferList))):void alert("error decoding file data: "+e)},function(e){console.error("decodeAudioData error",e)})},r.onerror=function(){alert("Error: Could not connect to audio files.")},r.send()},BufferLoader.prototype.load=function(){for(var e=0;e<this.urlList.length;++e)this.loadBuffer(this.urlList[e],e)};var click1=null,click2=null,click3=null,accent1=null,buffers=null,start=null;String.prototype.trimLeft=function(e){return void 0===e&&(e="s"),this.replace(RegExp("^["+e+"]+"),"")},String.prototype.trimRight=function(e){return void 0===e&&(e="s"),this.replace(RegExp("["+e+"]+$"),"")},String.prototype.trim=function(e){return this.trimLeft(e).trimRight(e)},String.prototype.insert=function(e,t){return e>0?this.substring(0,e)+t+this.substring(e,this.length):t+this},initSequence();
